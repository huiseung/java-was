<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link href="./reset.css" rel="stylesheet"/>
    <link href="./global.css" rel="stylesheet"/>
    <link href="./main.css" rel="stylesheet"/>
</head>
<body>
<div class="container">
    <header class="header">
        <a href="/"><img src="./img/signiture.svg"/></a>
        <ul class="header__menu">
            <li class="header__menu__item" id="loginItem">
                <a class="btn btn_contained btn_size_s" href="/login">로그인</a>
            </li>
            <li class="header__menu__item" id="registerItem">
                <a class="btn btn_ghost btn_size_s" href="/registration">
                    회원 가입
                </a>
            </li>
            <!--로그인 상태일 때 표시-->
            <li class="header__menu__item" id="userNickname" style="display: none;"></li>
            <li class="header__menu__item" id="logoutItem" style="display: none;">
                <a class="btn btn_contained btn_size_s" id="logoutBtn">로그아웃</a>
            </li>
            <li class="header__menu__item" id="userListItem" style="display: none;">
                <a class="btn btn_contained btn_size_s" href="/user/list">사용자 목록</a>
            </li>
        </ul>
    </header>
    <div class="wrapper">
        <div id="articleContainer"></div>
        <template id="articleTemplate">
            <div class="post">
                <div class="post__account">
                    <p class="post__account__nickname"></p>
                </div>
                <p class="post__title"></p>
                <img class="post__img"/>
                <div class="post__menu">
                    <ul class="post__menu__personal">
                        <li>
                            <button class="post__menu__btn">
                                <img src="./img/like.svg"/>
                            </button>
                        </li>
                        <li>
                            <button class="post__menu__btn">
                                <img src="./img/sendLink.svg"/>
                            </button>
                        </li>
                    </ul>
                    <button class="post__menu__btn">
                        <img src="./img/bookMark.svg"/>
                    </button>
                </div>
                <p class="post__article"></p>
            </div>
        </template>

        <nav class="nav">
            <ul class="nav__menu">
                <li class="nav__menu__item">
                    <a id="prevArticleBtn" class="nav__menu__item__btn" href="#" style="display: none;">
                        <img class="nav__menu__item__img" src="./img/ci_chevron-left.svg"/> 이전 글
                    </a>
                </li>
                <li class="nav__menu__item">
                    <span id="pageIndicator" style="display: none;"></span>
                </li>
                <li class="nav__menu__item">
                    <a id="nextArticleBtn" class="nav__menu__item__btn" href="#" style="display: none;"> 다음 글
                        <img class="nav__menu__item__img" src="./img/ci_chevron-right.svg"/>
                    </a>
                </li>
            </ul>
        </nav>
        <div>
            <a class="btn btn_contained btn_size_s" href="/article">글쓰기</a>
        </div>
        <div id="articleList"></div>
    </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const loginItem = document.getElementById('loginItem');
        const registerItem = document.getElementById('registerItem');
        const logoutItem = document.getElementById('logoutItem');
        const userNickname = document.getElementById('userNickname');
        const logoutBtn = document.getElementById('logoutBtn');
        const userListItem = document.getElementById('userListItem');

        function checkLoginStatus() {
          fetch('/me', {
            method: 'GET',
            credentials: 'include'
          })
          .then(response => response.text())
          .then(result => {
            if (result === "NO_USER" || result == "Not Found") {
              // 로그인하지 않은 상태
              loginItem.style.display = 'inline';
              registerItem.style.display = 'inline';
              logoutItem.style.display = 'none';
              userNickname.style.display = 'none';
              userListItem.style.display = 'none';
            } else {
              // 로그인한 상태
              loginItem.style.display = 'none';
              registerItem.style.display = 'none';
              logoutItem.style.display = 'inline';
              userNickname.textContent = `${result} 님`;
              userNickname.style.display = 'inline';
              userListItem.style.display = 'inline';
            }
          })
          .catch(error => {
            console.error('Error checking login status:', error);
            // 에러 발생 시 로그인하지 않은 상태로 처리
            loginItem.style.display = 'inline';
            registerItem.style.display = 'inline';
            logoutItem.style.display = 'none';
            userNickname.style.display = 'none';
            userListItem.style.display = 'none';
          });
        }

        logoutBtn.addEventListener('click', function(e) {
          e.preventDefault();
          fetch('/logout', {
            method: 'POST',
            credentials: 'include'
          })
          .then(response => {
            if (response.ok) {
              console.log('로그아웃 성공');
              checkLoginStatus(); // 로그아웃 후 상태 다시 확인
            } else {
              console.error('로그아웃 실패');
            }
          })
          .catch(error => {
            console.error('로그아웃 요청 중 오류 발생:', error);
          });
        });

        function fetchArticleList() {
            fetch('/api/articles')
                .then(response => response.json())
                .then(articles => {
                    console.log(articles);
                    displayArticleList(articles);
                })
                .catch(error => {
                    console.error('글 목록 가져오기 중 오류 발생:', error);
                });
        }

        function displayArticleList(articles) {
            const articleContainer = document.getElementById('articleContainer')
            const prevBtn = document.getElementById('prevArticleBtn')
            const nextBtn = document.getElementById('nextArticleBtn')
            const pageIndicator = document.getElementById('pageIndicator');

            articleContainer.innerHTML = '';

            if(articles.length == 0){
                const noArticleMessage = document.createElement('p');
                noArticleMessage.textContent = "작성된 글이 없습니다";
                noArticleMessage.style.textAlign = 'center';
                noArticleMessage.style.padding = '20px';
                noArticleMessage.style.fontSize = '16px';
                noArticleMessage.style.color = '#666';
                articleContainer.appendChild(noArticleMessage);

                prevBtn.style.display = 'none';
                nextBtn.style.display = 'none';
                pageIndicator.style.display = 'none';
                return;
            }

            pageIndicator.style.display = 'inline-block';

            articles.forEach((article, index) => {
                const articleElement = createArticleElement(article);
                articleContainer.appendChild(articleElement);

                if(index > 0){
                    articleElement.style.display = 'none';
                }
            })

            let currentIndex = 0;
            updateButtonVisibility();
            updatePageIndicator();

            prevBtn.onclick = function(e) {
                e.preventDefault();
                if (currentIndex > 0) {
                    articleContainer.children[currentIndex].style.display = 'none';
                    currentIndex--;
                    articleContainer.children[currentIndex].style.display = 'block';
                }
                updateButtonVisibility();
                updatePageIndicator();
            };

            nextBtn.onclick = function(e) {
                e.preventDefault();
                if (currentIndex < articles.length - 1) {
                    articleContainer.children[currentIndex].style.display = 'none';
                    currentIndex++;
                    articleContainer.children[currentIndex].style.display = 'block';
                }
                updateButtonVisibility();
                updatePageIndicator();
            };

            function updateButtonVisibility() {
                prevBtn.style.display = currentIndex > 0 ? 'inline-block' : 'none';
                nextBtn.style.display = currentIndex < articles.length - 1 ? 'inline-block' : 'none';
            }

            function updatePageIndicator() {
                pageIndicator.textContent = `${currentIndex + 1} / ${articles.length}`;
            }
        }

        function createArticleElement(article) {
            const template = document.getElementById('articleTemplate');
            const articleElement = template.content.cloneNode(true);
            const nickname = articleElement.querySelector('.post__account__nickname');
            nickname.textContent = article.author || 'account';

            const title = articleElement.querySelector('.post__title');
            title.textContent = article.title;

            const content = articleElement.querySelector('.post__article');
            content.textContent = article.content;


            const img = articleElement.querySelector('.post__img');
            img.src = `.${article.imagePath}` || '';
            return articleElement.firstElementChild;
        }

        checkLoginStatus(); // 초기 로그인 상태 확인
        fetchArticleList();
    });
</script>
</body>
</html>
